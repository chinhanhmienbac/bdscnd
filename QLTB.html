<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Thiết Bị - PVGAS LPG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap');

        body { background-color: #f4f6f9; font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; padding: 20px; }
        .excel-sheet { background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px 30px; min-height: 100vh; position: relative; border-radius: 8px; }
        
        /* Logo & Fonts */
        .site-logo { 
            position: absolute; top: 15px; left: 15px; width: 8%; z-index: 10; 
            transform: translate(15%, 10%); 
        }

        h1.main-title { 
            text-align: center; font-weight: 700; text-transform: uppercase; 
            margin-bottom: 5px; font-size: 34px; 
            color: #217346; font-family: 'Segoe UI', sans-serif; margin-top: 10px; 
        }
        h2.sub-title { 
            text-align: center; font-weight: 600; 
            font-size: 24px; 
            margin-bottom: 25px; color: #27ae60; font-family: 'Segoe UI', sans-serif; 
        }
        
        #facilityName { border-bottom: 2px dotted #27ae60; min-width: 150px; display: inline-block; color: #333; }

        /* Action Bar */
        .action-bar { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px; gap: 10px; flex-wrap: wrap; padding-right: 5px; }
        .form-check-input { cursor: pointer; width: 3em; height: 1.5em; }
        .edit-mode-label { font-weight: bold; color: #d63384; margin-right: 10px; user-select: none; font-size: 14px; }

        /* Table CSS */
        .table-container { max-height: 80vh; overflow-y: auto; border: 1px solid #000; }
        table.excel-table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        
        table.excel-table th { 
            position: sticky; top: 0; z-index: 5;
            background-color: #d9e1f2; border: 1px solid #a0a0a0;
            padding: 8px 4px; font-weight: bold; text-align: center; vertical-align: middle;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4); 
        }
        table.excel-table td { border: 1px solid #a0a0a0; padding: 6px 6px; vertical-align: top; }

        /* --- GRADIENT 3D ROW EFFECT --- */
        /* Dòng lẻ: Trắng thuần */
        table.excel-table tbody tr:nth-of-type(odd) td { 
            background-color: #ffffff;
        }
        
        /* Dòng chẵn: Gradient 3D (Sáng -> Tối -> Sáng) */
        table.excel-table tbody tr:nth-of-type(even) td { 
            background: linear-gradient(180deg, 
                #fdfdfd 0%,   /* Sáng ở mép trên */
                #eaeff2 50%,  /* Đậm hơn ở giữa (tạo khối) */
                #fdfdfd 100%  /* Sáng ở mép dưới */
            );
        }

        /* Hover: Gradient Xanh dương 3D */
        table.excel-table tbody tr:hover td { 
            background: linear-gradient(180deg, 
                #f0f8ff 0%, 
                #dbe9f6 50%, 
                #f0f8ff 100%
            ) !important;
            transition: background 0.15s ease;
        }

        /* Category Row */
        tr.category-row td { font-weight: 700; background-color: #fff2cc !important; vertical-align: middle; border-bottom: 1px solid #999; }

        /* Columns */
        .col-stt { width: 50px; text-align: center; font-weight: bold; }
        .col-name { width: 15%; }
        .col-data { width: auto; }

        /* Buttons & Inline Edit */
        .cell-actions { display: flex; gap: 3px; margin-bottom: 6px; justify-content: center; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 4px; opacity: 0.2; transition: opacity 0.3s; }
        td:hover .cell-actions { opacity: 1; }
        
        .btn-mini { border: none; font-size: 10px; padding: 3px 6px; border-radius: 3px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .btn-mini:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn-upload { background-color: #f39c12; } .btn-link { background-color: #3498db; }
        .btn-manage { background-color: #9b59b6; } .btn-collect { background-color: #27ae60; }
        
        .inline-edit { width: 100%; border: 1px solid #3498db; padding: 4px; background-color: rgba(255,255,255,0.8); font-weight: 600; font-size: 13px; border-radius: 3px; }

        /* Multi-link Box (Transparent to show gradient) */
        .multi-link-box { 
            max-height: 80px; overflow-y: auto; display: block; 
            background-color: transparent; 
            border: 1px solid rgba(0,0,0,0.05); 
            padding: 2px; border-radius: 3px; 
        }
        .multi-link-box::-webkit-scrollbar { width: 4px; }
        .multi-link-box::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

        /* Link Item (Reverted to standard QLTB3 style) */
        .link-item { 
            display: block; font-size: 12px; line-height: 1.6; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            border-bottom: 1px dashed rgba(0,0,0,0.1); padding: 1px 0; 
        }
        .link-item a { text-decoration: none; color: #0066cc; }
        .link-item a:hover { color: #d35400; text-decoration: underline; }

        /* Main Buttons */
        .btn-excel-export { background-color: #1D6F42; color: white; }
        .btn-excel-import { background-color: #e67e22; color: white; }
        .btn-batch { background-color: #8e44ad; color: white; }
        .btn-main { display: flex; align-items: center; gap: 6px; font-weight: 500; font-size: 13px; padding: 6px 12px; }

        /* Modals & Loading */
        #loadingMsg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .login-logo { width: 120px; display: block; margin: 0 auto 20px auto; }
        
        /* History Modal Table */
		.history-year-block { 
    margin-bottom: 20px; 
    border: 1px solid #e0e0e0; 
    padding: 15px; 
    border-radius: 8px; 
    background: #ffffff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* FIX: Tiêu đề Năm Đậm & Đỏ */
.history-year-title { 
    font-weight: 700 !important;  /* Bắt buộc in đậm */
    color: #dc3545 !important;    /* Màu đỏ đậm */
    font-size: 14px;
    text-transform: uppercase;    /* Viết hoa cho nổi bật */
    border-bottom: 2px solid #dc3545; /* Gạch chân màu đỏ */
    padding-bottom: 8px; 
    margin-bottom: 15px; 
    display: flex;
    align-items: center;
    gap: 8px;
}
        .history-detail-table { width: 100%; font-size: 12px; border-collapse: collapse; background: white; table-layout: fixed; }
        .history-detail-table th, .history-detail-table td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: middle; }
        .history-detail-table th { background: #f8f9fa; font-weight: 700; text-align: center; }
        .col-hist-date { width: 15%; text-align: center; } .col-hist-unit { width: 10%; text-align: center; }
        .col-hist-price { width: 25%; text-align: right; } .col-hist-total { width: 25%; text-align: right; font-weight: bold; color: #c0392b; }
        .col-hist-link { width: 10%; text-align: center; }
        
        .device-table { width: 100%; font-size: 12px; border-collapse: collapse; background: white; }
        .device-table th, .device-table td { border: 1px solid #ddd; padding: 4px 8px; }
        .manage-item-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .manage-item-del { color: #e74c3c; cursor: pointer; }
    </style>
</head>
<body>

<img src="https://pvgaslpg.com.vn/uploads/LPG%20xanh%20animation.gif" alt="Logo" class="site-logo">

<div id="loadingMsg">
    <div class="spinner-border text-light mb-2" role="status"></div>
    <div id="loadingText" style="font-size: 18px; font-weight: bold;">Đang xử lý...</div>
</div>

<div class="container-fluid">
    <div class="excel-sheet">
        <h1 class="main-title">QUẢN LÝ THIẾT BỊ</h1>
        <h2 class="sub-title">TÊN CƠ SỞ: <span id="facilityName">..........................</span></h2>

        <div class="action-bar">
            <button id="authBtn" class="btn btn-primary btn-sm btn-main" onclick="handleAuthClick()">
                <i class="fab fa-google-drive"></i> Đăng nhập Drive
            </button>
            <span id="authStatus" style="font-size: 12px; color: green; font-weight: bold; display: none; margin-right: 15px;">
                <i class="fas fa-check-circle"></i> Drive đã kết nối
            </span>

            <div class="form-check form-switch d-flex align-items-center gap-2">
                <input class="form-check-input" type="checkbox" id="editModeToggle">
                <label class="form-check-label edit-mode-label" for="editModeToggle">Chỉnh sửa</label>
            </div>

            <div id="viewModeBtns" class="d-flex gap-2">
                <button class="btn btn-sm btn-main btn-excel-export" onclick="exportMainData()">
                    <i class="fas fa-file-export"></i> Xuất Excel (Sao lưu)
                </button>
            </div>

            <div id="editModeBtns" class="d-flex gap-2" style="display: none !important;">
                <button class="btn btn-sm btn-main btn-batch" onclick="batchCollectBDSC()">
                    <i class="fas fa-sync-alt"></i> Cập nhật Lịch sử (All)
                </button>
                <button class="btn btn-sm btn-main btn-excel-import" onclick="document.getElementById('fileInputExcel').click()">
                    <i class="fas fa-file-import"></i> Nhập Excel (Merge)
                </button>
            </div>
            
            <button class="btn btn-secondary btn-sm btn-main" onclick="location.reload()">
                <i class="fas fa-redo"></i>
            </button>
        </div>

        <div class="table-container">
            <table class="excel-table" id="mainTable">
                <thead>
                    <tr>
                        <th class="col-stt">STT</th>
                        <th class="col-name">Tên thiết bị / Loại</th>
                        <th class="col-data">Tagname</th>
                        <th class="col-data" data-name="Thông số KT">Thông số KT</th>
                        <th class="col-data" data-name="Catalogue">Catalogue</th>
                        <th class="col-data" data-name="Kiểm định">Kiểm định</th>
                        <th class="col-data" data-name="Quy trình VH">Quy trình VH</th>
                        <th class="col-data" data-name="Quy trình BD">Quy trình BD</th>
                        <th class="col-data" data-name="Định mức">Định mức</th>
                        <th class="col-data" data-name="Đánh giá rủi ro">ĐGRR</th>
                        <th class="col-data" data-name="Biểu mẫu">Biểu mẫu</th>
                        <th class="col-data" data-name="Lịch sử BDSC">Lịch sử BDSC</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade modal-login" id="loginModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" style="width: 350px;">
        <div class="modal-content">
            <div class="modal-body">
                <img src="https://pvgaslpg.com.vn/uploads/LPG%20xanh%20animation.gif" alt="Logo" class="login-logo">
                <h5 class="text-center fw-bold mb-4 text-success">ĐĂNG NHẬP HỆ THỐNG</h5>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tài khoản</label>
                        <select class="form-select" id="loginEmail">
                            <option value="bdsc-cnmb@pvgaslpg.com.vn">*****@pvgaslpg.com.vn</option>
                            <option value="admin@pvgaslpg.com.vn">admin@pvgaslpg.com.vn</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mật khẩu</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">Đăng nhập</button>
                        <button type="button" class="btn btn-light text-muted" onclick="closeLoginModal()">Hủy bỏ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="manageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title fs-6 fw-bold">Quản lý Tài liệu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="manageListContainer"></div>
            </div>
            <div class="modal-footer py-1">
                <button type="button" class="btn btn-primary btn-sm" onclick="saveManageChanges()">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2 d-flex justify-content-between">
                <h5 class="modal-title fs-6 fw-bold" id="historyModalTitle">Chi tiết Lịch sử</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-light btn-sm text-success fw-bold" onclick="exportCurrentHistory()">
                        <i class="fas fa-file-excel"></i> Xuất Excel
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" id="historyModalBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning py-2">
                <h5 class="modal-title fs-6 fw-bold text-dark">Quản lý Thiết bị trong Phân loại</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="deviceModalContent">
                    <table class="device-table" id="deviceTableList">
                        <thead>
                            <tr>
                                <th style="width:50px">STT</th>
                                <th>Tên Thiết bị</th>
                                <th style="width:50px">Xoá</th>
                            </tr>
                        </thead>
                        <tbody id="deviceTableBody"></tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <label class="form-label fw-bold small">Thêm thiết bị mới:</label>
                    <div class="input-group input-group-sm">
                        <input type="text" id="newDeviceName" class="form-control" placeholder="Nhập tên thiết bị...">
                        <button class="btn btn-success" onclick="addNewDevice()">
                            <i class="fas fa-plus"></i> Thêm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="file" id="fileInputExcel" accept=".xlsx, .xls" style="display: none;">
<input type="file" id="driveUploadInput" style="display: none;">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, setPersistence, browserSessionPersistence, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDltV6zgLaOHZANarD4I87ckl0jBWY8leU",
        authDomain: "dulieubanhang-d6156.firebaseapp.com",
        databaseURL: "https://dulieubanhang-d6156-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dulieubanhang-d6156",
        storageBucket: "dulieubanhang-d6156.firebasestorage.app",
        messagingSenderId: "588583798336",
        appId: "1:588583798336:web:82a240fb3da2f96893c1a5",
        measurementId: "G-7D51WBK63L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const CLIENT_ID = "588583798336-o4gjnfqaupmmdp8mi38o9m8r4n0bbghs.apps.googleusercontent.com";
    const FOLDER_ID = "1uyHJHfNFLIdPQbYu1uF4zliORCM6QK3P";
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const TARGET_YEARS = [2023, 2024, 2025];

    // Helpers (Declared Top)
    window.showLoading = function(msg) { document.getElementById('loadingText').innerText = msg; document.getElementById('loadingMsg').style.display = "flex"; };
    window.hideLoading = function() { document.getElementById('loadingMsg').style.display = "none"; };
    window.romanToInt = function(s) { if(!s) return 0; const r = {'I':1,'V':5,'X':10,'L':50}; let n=0; for(let i=0;i<s.length;i++){ if(i+1<s.length && r[s[i]]<r[s[i+1]]) n-=r[s[i]]; else n+=r[s[i]]; } return n; };
    window.formatNum = function(n) { return n ? n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "-"; };
    window.markDeleted = function(el) { el.closest('.manage-item-row').classList.add('d-none', 'marked-delete'); };

    // DOM Elements
    const elements = {
        tableBody: document.getElementById('tableBody'),
        facilityName: document.getElementById('facilityName'),
        editToggle: document.getElementById('editModeToggle'),
        authBtn: document.getElementById('authBtn'),
        authStatus: document.getElementById('authStatus'),
        viewBtns: document.getElementById('viewModeBtns'),
        editBtns: document.getElementById('editModeBtns'),
        driveInput: document.getElementById('driveUploadInput'),
        loginModal: new bootstrap.Modal(document.getElementById('loginModal')),
        manageModal: new bootstrap.Modal(document.getElementById('manageModal')),
        historyModal: new bootstrap.Modal(document.getElementById('historyModal')),
        deviceModal: new bootstrap.Modal(document.getElementById('deviceModal'))
    };

    let tokenClient, accessToken = null, localDataCache = null, localViewMode = false;
    let currentUploadTarget = null, currentManageTarget = null, currentHistoryData = null, currentCategoryForDevice = null;

    // --- 1. SESSION SECURITY (Logout on Close) ---
    function checkSessionValidity() {
        const sessionFlag = sessionStorage.getItem('app_active_session');
        if (!sessionFlag) {
            // New tab or browser restart -> Force Logout
            signOut(auth).then(() => {
                sessionStorage.setItem('app_active_session', 'true');
            }).catch(() => {
                sessionStorage.setItem('app_active_session', 'true');
            });
        }
    }

    window.onload = function() {
        checkSessionValidity(); // Check session on load
        loadAllData();
        checkPersistentDriveAuth();
        
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (tokenResponse) => {
                accessToken = tokenResponse.access_token;
                if (accessToken) {
                    localStorage.setItem('gdrive_token', accessToken);
                    localStorage.setItem('gdrive_expiry', Date.now() + 3500 * 1000); 
                    updateAuthUI(true);
                }
            },
        });
    };

    function checkPersistentDriveAuth() {
        const storedToken = localStorage.getItem('gdrive_token');
        const expiry = localStorage.getItem('gdrive_expiry');
        if (storedToken && expiry && Date.now() < parseInt(expiry)) {
            accessToken = storedToken;
            updateAuthUI(true);
        }
    }

    function updateAuthUI(isLoggedIn) {
        if(isLoggedIn) { elements.authBtn.style.display = 'none'; elements.authStatus.style.display = 'inline-block'; }
    }

    window.handleAuthClick = function() { if (!accessToken) tokenClient.requestAccessToken({prompt: 'consent'}); };

    // --- FIREBASE LOGIN ---
    elements.editToggle.addEventListener('click', (e) => {
        if (e.target.checked) {
            if (auth.currentUser) {
                setEditMode(true);
            } else {
                e.preventDefault();
                elements.loginModal.show();
            }
        } else {
            setEditMode(false);
        }
    });

    window.closeLoginModal = function() { elements.loginModal.hide(); elements.editToggle.checked = false; }

    window.handleLogin = async function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        window.showLoading("Đang đăng nhập...");
        try {
            await setPersistence(auth, browserSessionPersistence);
            await signInWithEmailAndPassword(auth, email, password);
            elements.loginModal.hide();
            elements.editToggle.checked = true;
            setEditMode(true);
            document.getElementById('loginPassword').value = "";
        } catch (error) {
            alert("Đăng nhập thất bại: " + error.message);
            elements.editToggle.checked = false;
        } finally {
            window.hideLoading();
        }
    };

    function setEditMode(isEdit) {
        localViewMode = isEdit;
        if(isEdit) {
            elements.viewBtns.style.setProperty('display', 'none', 'important');
            elements.editBtns.style.setProperty('display', 'flex', 'important');
        } else {
            elements.viewBtns.style.setProperty('display', 'flex', 'important');
            elements.editBtns.style.setProperty('display', 'none', 'important');
        }
        renderTable(localDataCache);
    }

    // --- DATA RENDERING ---
    function loadAllData() {
        window.showLoading("Đang tải dữ liệu...");
        Promise.all([
            get(ref(db, 'settings/tenCoSo')),
            get(ref(db, 'Quanlythietbi'))
        ]).then((results) => {
            const name = results[0].val();
            localDataCache = results[1].val();
            elements.facilityName.textContent = name ? name : "..........................";
            renderTable(localDataCache);
        }).catch((error) => { console.error(error); alert("Lỗi tải dữ liệu."); })
          .finally(() => window.hideLoading());
    }

    function renderTable(data) {
        elements.tableBody.innerHTML = "";
        if (!data) { elements.tableBody.innerHTML = "<tr><td colspan='12' class='text-center'>Chưa có dữ liệu</td></tr>"; return; }

        const categories = Object.keys(data).sort((a, b) => window.romanToInt(a) - window.romanToInt(b));

        categories.forEach(catKey => {
            const catData = data[catKey];
            const rowCat = document.createElement('tr');
            rowCat.className = "category-row";
            
            if (localViewMode) {
                rowCat.innerHTML = `<td class="col-stt">${catKey}</td>
                                    <td colspan="9">${catData.TenPhanLoai || ""}</td>
                                    <td colspan="2" class="text-center align-middle">
                                        <button class="btn btn-warning btn-sm fw-bold" style="font-size:11px; padding: 2px 5px;" onclick="openDeviceModal('${catKey}')">
                                            <i class="fas fa-cog"></i> QL Thiết bị
                                        </button>
                                    </td>`;
            } else {
                rowCat.innerHTML = `<td class="col-stt">${catKey}</td><td colspan="11">${catData.TenPhanLoai || ""}</td>`;
            }
            elements.tableBody.appendChild(rowCat);

            const itemKeys = Object.keys(catData).filter(k => !isNaN(k)).sort((a,b) => a - b);
            
            itemKeys.forEach(itemKey => {
                const item = catData[itemKey];
                const rowItem = document.createElement('tr');

                const createCell = (value, fieldName, isUploadable = false) => {
                    if (fieldName === 'LichSuBDSC') {
                        let content = "";
                        if (typeof value === 'object' && value !== null) {
                            content = `<button class="btn-mini btn-link" onclick="viewHistoryDetail('${catKey}', '${itemKey}')"><i class="fas fa-eye"></i> Xem Chi Tiết</button>`;
                        } else {
                            if (value && value.toString().startsWith('http')) content = `<a href="${value}" target="_blank">Xem Link</a>`;
                            else content = value || "";
                        }
                        if (localViewMode) {
                            return `<div class="cell-actions">
                                        <button class="btn-mini btn-collect" onclick="collectBDSC('${catKey}', '${itemKey}', '${item.Tagname}')"><i class="fas fa-magic"></i> Thu thập</button>
                                    </div>` + content;
                        }
                        return content;
                    }
                    if (fieldName === 'TenThietBi' || fieldName === 'Tagname') {
                        if (localViewMode) return `<input type="text" class="inline-edit" value="${value || ''}" onchange="updateInline('${catKey}', '${itemKey}', '${fieldName}', this.value)">`;
                        return value || "";
                    }
                    let htmlContent = renderMultiLinkList(value);
                    if (localViewMode && isUploadable) {
                         const toolbar = `
                            <div class="cell-actions">
                                <button class="btn-mini btn-upload" title="Upload" onclick="triggerUpload('${catKey}', '${itemKey}', '${fieldName}')"><i class="fas fa-cloud-upload-alt"></i></button>
                                <button class="btn-mini btn-link" title="Thêm Link" onclick="triggerManualLink('${catKey}', '${itemKey}', '${fieldName}')"><i class="fas fa-plus"></i></button>
                                <button class="btn-mini btn-manage" title="Sửa/Xoá" onclick="openManageModal('${catKey}', '${itemKey}', '${fieldName}')"><i class="fas fa-edit"></i></button>
                            </div>`;
                        return toolbar + htmlContent;
                    } 
                    return htmlContent;
                };

                rowItem.innerHTML = `
                    <td class="text-center fw-bold text-muted">${itemKey}</td>
                    <td>${createCell(item.TenThietBi, 'TenThietBi')}</td>
                    <td>${createCell(item.Tagname, 'Tagname', false)}</td> 
                    <td>${createCell(item.ThongSoKT, 'ThongSoKT', true)}</td>
                    <td>${createCell(item.Catalogue, 'Catalogue', true)}</td>
                    <td>${createCell(item.KiemDinh, 'KiemDinh', true)}</td>
                    <td>${createCell(item.QuyTrinhVH, 'QuyTrinhVH', true)}</td>
                    <td>${createCell(item.QuyTrinhBD, 'QuyTrinhBD', true)}</td>
                    <td>${createCell(item.DinhMuc, 'DinhMuc', true)}</td>
                    <td>${createCell(item.DGRR, 'DGRR', true)}</td>
                    <td>${createCell(item.BieuMau, 'BieuMau', true)}</td>
                    <td>${createCell(item.LichSuBDSC, 'LichSuBDSC')}</td>
                `;
                elements.tableBody.appendChild(rowItem);
            });
        });
    }

    // --- OTHER FUNCTIONS ---
    window.openDeviceModal = function(catKey) {
        currentCategoryForDevice = catKey;
        const tbody = document.getElementById('deviceTableBody');
        tbody.innerHTML = "";
        const catData = localDataCache[catKey];
        const itemKeys = Object.keys(catData).filter(k => !isNaN(k)).sort((a,b) => a - b);
        itemKeys.forEach(key => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="text-center fw-bold">${key}</td><td>${catData[key].TenThietBi || "(Chưa đặt tên)"}</td><td class="text-center"><button class="btn btn-danger btn-sm" style="font-size: 10px;" onclick="deleteDevice('${catKey}', '${key}')"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('newDeviceName').value = "";
        elements.deviceModal.show();
    };

    window.addNewDevice = async function() {
        if(!currentCategoryForDevice) return;
        const name = document.getElementById('newDeviceName').value.trim();
        if(!name) { alert("Vui lòng nhập tên thiết bị"); return; }
        const catData = localDataCache[currentCategoryForDevice];
        const itemKeys = Object.keys(catData).filter(k => !isNaN(k)).map(k => parseInt(k));
        const newId = itemKeys.length > 0 ? Math.max(...itemKeys) + 1 : 1;
        window.showLoading("Đang thêm...");
        try {
            await set(ref(db, `Quanlythietbi/${currentCategoryForDevice}/${newId}`), { TenThietBi: name, Tagname: "" });
            if(!localDataCache[currentCategoryForDevice]) localDataCache[currentCategoryForDevice] = {};
            localDataCache[currentCategoryForDevice][newId] = { TenThietBi: name };
            openDeviceModal(currentCategoryForDevice); renderTable(localDataCache);
        } catch(err) { alert("Lỗi: " + err.message); } finally { window.hideLoading(); }
    };

    window.deleteDevice = async function(catKey, itemKey) {
        if(!confirm(`Bạn chắc chắn muốn xoá thiết bị STT ${itemKey}?`)) return;
        window.showLoading("Đang xoá...");
        try {
            await remove(ref(db, `Quanlythietbi/${catKey}/${itemKey}`));
            delete localDataCache[catKey][itemKey];
            openDeviceModal(catKey); renderTable(localDataCache);
        } catch(err) { alert("Lỗi: " + err.message); } finally { window.hideLoading(); }
    };

    window.openManageModal = function(catKey, itemKey, fieldName) {
        currentManageTarget = { catKey, itemKey, fieldName };
        const container = document.getElementById('manageListContainer'); container.innerHTML = "";
        let data = localDataCache[catKey][itemKey][fieldName];
        let items = [];
        if (data) { if (typeof data === 'string') items = [{ name: "Link cũ", url: data }]; else if (Array.isArray(data)) items = [...data]; else if (typeof data === 'object') items = Object.values(data); }
        
        if(items.length === 0) container.innerHTML = "<div class='text-center text-muted'>Trống</div>";
        else {
            items.forEach((item, index) => {
                const displayName = item.name || "File";
                const row = document.createElement('div'); row.className = "manage-item-row";
                row.innerHTML = `<input type="text" class="form-control form-control-sm" value="${displayName}" id="linkName-${index}"><a href="${item.url}" target="_blank"><i class="fas fa-external-link-alt"></i></a><i class="fas fa-trash-alt manage-item-del" onclick="markDeleted(this)"></i><input type="hidden" id="linkUrl-${index}" value="${item.url}"><input type="hidden" id="linkCreated-${index}" value="${item.created || Date.now()}">`;
                container.appendChild(row);
            });
        }
        elements.manageModal.show();
    };

    window.saveManageChanges = async function() {
        if (!currentManageTarget) return;
        const { catKey, itemKey, fieldName } = currentManageTarget;
        const rows = document.querySelectorAll('#manageListContainer .manage-item-row');
        const newData = [];
        rows.forEach((row, index) => {
            if (row.classList.contains('marked-delete')) return;
            const name = row.querySelector(`#linkName-${index}`).value;
            const url = row.querySelector(`#linkUrl-${index}`).value;
            const created = row.querySelector(`#linkCreated-${index}`).value;
            if (url) newData.push({ name: name || "File", url: url, created: parseInt(created) });
        });
        window.showLoading("Đang lưu...");
        try {
            await set(ref(db, `Quanlythietbi/${catKey}/${itemKey}/${fieldName}`), newData);
            if (!localDataCache[catKey][itemKey]) localDataCache[catKey][itemKey] = {};
            localDataCache[catKey][itemKey][fieldName] = newData;
            renderTable(localDataCache); elements.manageModal.hide();
        } catch(err) { alert(err.message); } finally { window.hideLoading(); }
    };

    window.viewHistoryDetail = function(catKey, itemKey) {
        currentHistoryData = localDataCache[catKey][itemKey]['LichSuBDSC'];
        const devName = localDataCache[catKey][itemKey]['TenThietBi'];
        const container = document.getElementById('historyModalBody'); container.innerHTML = "";
        document.getElementById('historyModalTitle').innerText = `Lịch sử: ${devName}`;

        if(!currentHistoryData) { container.innerHTML = "Trống"; elements.historyModal.show(); return; }
        
        Object.keys(currentHistoryData).sort().reverse().forEach(year => {
            let html = `<div class="history-year-block"><div class="history-year-title">Năm ${year}</div>`;
            Object.values(currentHistoryData[year]).forEach(t => {
                html += `<div class="mb-2"><strong>${t.noiDung}</strong>`;
                if(t.details) {
                    html += `<table class="history-detail-table">
                                <thead><tr>
                                    <th class="col-hist-date">Ngày</th>
                                    <th class="col-hist-unit">SL</th>
                                    <th class="col-hist-price">Đơn giá</th>
                                    <th class="col-hist-total">Thành tiền</th>
                                    <th class="col-hist-link">HS</th>
                                </tr></thead><tbody>`;
                    Object.values(t.details).forEach(d => {
                        html += `<tr>
                                    <td class="text-center">${d.ngayThucHien}</td>
                                    <td class="text-center">${d.dvt}</td>
                                    <td class="text-end">${window.formatNum(d.donGia)}</td>
                                    <td class="text-end fw-bold">${window.formatNum(d.thanhTien)}</td>
                                    <td class="text-center">${d.hoSoLink ? '<a href="'+d.hoSoLink+'" target="_blank"><i class="fas fa-file-alt"></i></a>' : '-'}</td>
                                 </tr>`;
                    });
                    html += `</tbody></table>`;
                }
                html += `</div>`;
            });
            container.innerHTML += html + "</div>";
        });
        elements.historyModal.show();
    };

    window.updateInline = function(c, i, f, v) { update(ref(db, `Quanlythietbi/${c}/${i}`), {[f]:v}); localDataCache[c][i][f]=v; };
    
    window.exportMainData = function() {
        if (!localDataCache) return;
        const rows = [["STT", "Tên thiết bị", "Tagname", "Thông số KT", "Catalogue", "Kiểm định", "Quy trình VH", "Quy trình BD", "Định mức", "ĐGRR", "Biểu mẫu"]];
        Object.keys(localDataCache).sort((a,b)=>window.romanToInt(a)-window.romanToInt(b)).forEach(catKey => {
            rows.push([catKey, localDataCache[catKey].TenPhanLoai]); 
            const items = localDataCache[catKey];
            Object.keys(items).filter(k=>!isNaN(k)).sort((a,b)=>a-b).forEach(key => {
                const i = items[key];
                const getVal = (v) => (typeof v === 'string') ? v : (Array.isArray(v) ? v.map(x=>x.url).join(';') : "");
                rows.push([key, i.TenThietBi, i.Tagname, getVal(i.ThongSoKT), getVal(i.Catalogue), getVal(i.KiemDinh), getVal(i.QuyTrinhVH), getVal(i.QuyTrinhBD), getVal(i.DinhMuc), getVal(i.DGRR), getVal(i.BieuMau)]);
            });
        });
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "DS"); XLSX.writeFile(wb, "Backup.xlsx");
    };

    window.collectBDSC = async function(catKey, itemKey, tagName) {
        if (!tagName) { alert("Chưa có Tagname!"); return; }
        window.showLoading("Đang quét...");
        try {
            const lockedSnapshot = await get(ref(db, 'settings/global/lockedYears'));
            const lockedYears = lockedSnapshot.val() || {};
            const activeYears = TARGET_YEARS.filter(y => lockedYears[y] !== true);
            let collectedData = {}; let found = false;
            for (let year of activeYears) {
                const snapshot = await get(ref(db, `congViecMe${year}`));
                if (!snapshot.exists()) continue;
                const sourceMap = { [year]: snapshot.val() };
                const res = searchHistoryInMemory(sourceMap, tagName);
                if(res) { collectedData[year] = res[year]; found = true; }
            }
            if (found) {
                const current = localDataCache[catKey][itemKey].LichSuBDSC || {};
                Object.assign(current, collectedData);
                await update(ref(db, `Quanlythietbi/${catKey}/${itemKey}`), { LichSuBDSC: current });
                localDataCache[catKey][itemKey]['LichSuBDSC'] = current;
                renderTable(localDataCache);
                alert("Đã thu thập!");
            } else alert("Không tìm thấy dữ liệu mới.");
        } catch (e) { alert(e.message); } finally { window.hideLoading(); }
    };

    window.batchCollectBDSC = async function() {
        if(!confirm("Cập nhật TOÀN BỘ?")) return;
        window.showLoading("Đang xử lý...");
        try {
            const lockedSnapshot = await get(ref(db, 'settings/global/lockedYears'));
            const lockedYears = lockedSnapshot.val() || {};
            const activeYears = TARGET_YEARS.filter(y => lockedYears[y] !== true);
            const sourceData = {};
            for(let year of activeYears) {
                const snap = await get(ref(db, `congViecMe${year}`));
                if(snap.exists()) sourceData[year] = snap.val();
            }
            const updates = {};
            for(const catKey in localDataCache) {
                const items = localDataCache[catKey];
                for(const itemKey in items) {
                    if(isNaN(itemKey)) continue;
                    const item = items[itemKey];
                    if(!item.Tagname) continue;
                    const found = searchHistoryInMemory(sourceData, item.Tagname);
                    if(found) {
                        const current = item.LichSuBDSC || {};
                        Object.assign(current, found);
                        updates[`Quanlythietbi/${catKey}/${itemKey}/LichSuBDSC`] = current;
                    }
                }
            }
            if(Object.keys(updates).length > 0) { await update(ref(db), updates); await loadAllData(); alert("Xong!"); } 
            else alert("Không có dữ liệu mới.");
        } catch(e) { alert(e.message); } finally { window.hideLoading(); }
    };

    function searchHistoryInMemory(sourceData, tagName) {
        let result = {}; let hasData = false;
        for(const [year, yearData] of Object.entries(sourceData)) {
            for(const gData of Object.values(yearData)) {
                if(!gData.children) continue;
                for(const cData of Object.values(gData.children)) {
                    if(!cData.grandchildren) continue;
                    for(const [grandId, grData] of Object.entries(cData.grandchildren)) {
                        if(grData.tagName === tagName && grData.daThucHien === true && grData.greatGrandchildren) {
                            if(!result[year]) result[year] = {};
                            for(const [ggId, ggData] of Object.entries(grData.greatGrandchildren)) {
                                if(ggData.executions) {
                                    const entryId = `${grandId}_${ggId}`;
                                    const details = {};
                                    for(const [k, v] of Object.entries(ggData.executions)) { if(!isNaN(k) && typeof v === 'object') details[k] = v; }
                                    result[year][entryId] = { noiDung: ggData.noiDung || "N/A", details: details };
                                    hasData = true;
                                }
                            }
                            break;
                        }
                    }
                }
            }
        }
        return hasData ? result : null;
    }

    window.triggerUpload = function(c,i,f) { if(!accessToken) { alert("Vui lòng nhấn nút 'Đăng nhập Drive' trước!"); return; } currentUploadTarget={c,i,f}; elements.driveInput.click(); };
    elements.driveInput.addEventListener('change', async(e)=>{
        const f=e.target.files[0]; if(!f) return;
        const {c,i,f:fd} = currentUploadTarget;
        const name = prompt("Nhập tên hiển thị cho file này:", f.name); if(!name) return;
        window.showLoading("Uploading...");
        const meta = { 'name': f.name, 'mimeType': f.type, 'parents': [FOLDER_ID] };
        const form = new FormData(); form.append('metadata', new Blob([JSON.stringify(meta)], {type:'application/json'})); form.append('file', f);
        try {
            const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
                method:'POST', headers:{'Authorization':'Bearer '+accessToken}, body:form});
            const res = await r.json();
            let arr = localDataCache[c][i][fd] || []; if(!Array.isArray(arr)) arr = arr.url ? [arr] : [];
            arr.push({name: name, url: res.webViewLink, created: Date.now()});
            await set(ref(db, `Quanlythietbi/${c}/${i}/${fd}`), arr);
            localDataCache[c][i][fd] = arr; renderTable(localDataCache);
        } catch(e){ alert(e.message); } finally { window.hideLoading(); elements.driveInput.value=""; }
    });

    window.triggerManualLink = async function(c,i,f) {
        const u = prompt("Dán đường link tài liệu của bạn vào đây:"); if(!u) return; const n = prompt("Nhập tên hiển thị cho link này:"); if(!n) return;
        let arr = localDataCache[c][i][f] || []; if(!Array.isArray(arr)) arr = arr.url ? [arr] : [];
        arr.push({name:n, url:u, created: Date.now()});
        await set(ref(db, `Quanlythietbi/${c}/${i}/${f}`), arr); localDataCache[c][i][f] = arr; renderTable(localDataCache);
    };

    window.exportCurrentHistory = function() {
        if(!currentHistoryData) return;
        const rows = [["Năm", "Nội dung", "Ngày", "SL", "Đơn giá", "Thành tiền", "Link"]];
        const flat = [];
        Object.keys(currentHistoryData).forEach(y => {
            Object.values(currentHistoryData[y]).forEach(t => {
                if(t.details) Object.values(t.details).forEach(d => flat.push({y, c:t.noiDung, ...d}));
            });
        });
        flat.sort((a,b) => (a.ngayThucHien||"").localeCompare(b.ngayThucHien||""));
        flat.forEach(i => rows.push([i.y, i.c, i.ngayThucHien, i.dvt, i.donGia, i.thanhTien, i.hoSoLink]));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "History"); XLSX.writeFile(wb, "History.xlsx");
    };

    // --- REVERTED TOOLTIP LOGIC (Use 'title' attribute) ---
    function renderMultiLinkList(d) {
        if(!d || typeof d !== 'object' || (!Array.isArray(d) && !d.url)) return "";
        let items = Array.isArray(d) ? [...d].reverse() : [d];
        if(!Array.isArray(d) && d.noiDung) return ""; 
        if(items.length===0) return "";
        let h = '<div class="multi-link-box">';
        items.forEach(l => { 
            // Use browser native tooltip (title)
            if(l.url) h+=`<div class="link-item"><i class="fas fa-caret-right text-muted" style="font-size:10px;"></i> <a href="${l.url}" target="_blank" title="${l.name||"File"}">${l.name||"File"}</a></div>`; 
        });
        return h + '</div>';
    }
</script>
</body>
</html>
