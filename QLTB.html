<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Thiết Bị</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body { background-color: #f0f0f0; font-family: Arial, sans-serif; font-size: 13px; padding: 20px; }
        .excel-sheet { background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px 30px; min-height: 100vh; }
        
        h1.main-title { text-align: center; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; font-size: 24px; }
        h2.sub-title { text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 20px; }
        #facilityName { border-bottom: 1px dotted #999; min-width: 100px; display: inline-block; }

        /* Action Bar */
        .action-bar { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; gap: 15px; flex-wrap: wrap; }
        .form-check-input { cursor: pointer; width: 2.5em; height: 1.25em; }
        .edit-mode-label { font-weight: bold; color: #d63384; margin-right: 10px; user-select: none; }

        /* Table Structure */
        table.excel-table { width: 100%; border-collapse: collapse; border: 1px solid #000; table-layout: fixed; }
        table.excel-table th, table.excel-table td { 
            border: 1px solid #a0a0a0; padding: 4px 6px; vertical-align: top; 
        }
        table.excel-table th { background-color: #d9e1f2; font-weight: bold; text-align: center; vertical-align: middle; }

        /* Cột */
        .col-stt { width: 40px; text-align: center; font-weight: bold; }
        .col-name { width: 15%; }
        .col-data { width: auto; }

        /* Edit Components */
        .inline-edit { width: 100%; border: 1px solid #2980b9; padding: 2px 4px; background-color: #eaf2f8; font-weight: bold; font-size: 13px; }
        
        /* Multi-link Box */
        .multi-link-box {
            max-height: 80px; overflow-y: auto; overflow-x: hidden;
            display: block; background-color: #fff; border: 1px solid #eee;
            padding: 2px; border-radius: 3px;
        }
        .multi-link-box::-webkit-scrollbar { width: 6px; }
        .multi-link-box::-webkit-scrollbar-track { background: #f1f1f1; }
        .multi-link-box::-webkit-scrollbar-thumb { background: #bbb; border-radius: 3px; }
        
        .link-item { 
            display: block; font-size: 12px; line-height: 1.6;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            padding: 1px 4px; border-bottom: 1px dashed #eee; 
        }
        .link-item:last-child { border-bottom: none; }
        .link-item a { text-decoration: none; color: #0066cc; font-weight: 500; }
        .link-item a:hover { text-decoration: underline; color: #d35400; }

        /* Buttons in Cell */
        .cell-actions { display: flex; gap: 3px; margin-bottom: 6px; justify-content: center; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
        .btn-mini { border: none; font-size: 10px; padding: 3px 6px; border-radius: 3px; cursor: pointer; color: white; font-weight: bold; }
        .btn-upload { background-color: #f39c12; }
        .btn-link { background-color: #3498db; }
        .btn-manage { background-color: #9b59b6; } /* Màu tím cho nút quản lý */
        .btn-mini:hover { opacity: 0.8; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }

        tr.category-row td { font-weight: bold; background-color: #fff2cc; vertical-align: middle; }
        #fileInputExcel, #driveUploadInput { display: none; }
        .btn-excel { background-color: #217346; color: white; border: none; padding: 5px 15px; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .btn-google { background-color: #4285F4; color: white; border: none; padding: 5px 15px; font-size: 14px; display: flex; align-items: center; gap: 5px; }

        /* Loading & Modal Styles */
        #loadingMsg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 9999; display: none;
            justify-content: center; align-items: center; flex-direction: column; color: white;
        }
        
        /* Styles cho danh sách trong Modal */
        .manage-item-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .manage-item-row:last-child { border-bottom: none; margin-bottom: 0; }
        .manage-item-input { flex-grow: 1; }
        .manage-item-link { color: #2980b9; font-size: 18px; cursor: pointer; }
        .manage-item-del { color: #c0392b; font-size: 18px; cursor: pointer; }
        .manage-item-del:hover { color: #e74c3c; }
    </style>
</head>
<body>

<div id="loadingMsg">
    <div class="spinner-border text-light mb-2" role="status"></div>
    <div id="loadingText" style="font-size: 18px; font-weight: bold;">Đang xử lý...</div>
</div>

<div class="container-fluid">
    <div class="excel-sheet">
        <h1 class="main-title">QUẢN LÝ THIẾT BỊ</h1>
        <h2 class="sub-title">TÊN CƠ SỞ: <span id="facilityName">..........................</span></h2>

        <div class="action-bar">
            <button id="authBtn" class="btn btn-google" onclick="handleAuthClick()">
                <i class="fab fa-google-drive"></i> Đăng nhập Drive
            </button>
            <span id="authStatus" style="font-size: 12px; color: green; font-weight: bold; display: none;">
                <i class="fas fa-check-circle"></i> Đã kết nối Drive
            </span>

            <div class="form-check form-switch ms-3">
                <input class="form-check-input" type="checkbox" id="editModeToggle">
                <label class="form-check-label edit-mode-label" for="editModeToggle">Chỉnh sửa</label>
            </div>

            <button class="btn btn-primary btn-sm" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Tải lại
            </button>
            
            <input type="file" id="fileInputExcel" accept=".xlsx, .xls">
            <button class="btn btn-excel" onclick="document.getElementById('fileInputExcel').click()">
                <i class="fas fa-file-excel"></i> Nhập Excel
            </button>
        </div>

        <table class="excel-table" id="mainTable">
            <thead>
                <tr>
                    <th class="col-stt">STT</th>
                    <th class="col-name">Tên thiết bị / Loại</th>
                    <th class="col-data">Tagname</th>
                    <th class="col-data" data-name="Thông số KT">Thông số KT</th>
                    <th class="col-data" data-name="Catalogue">Catalogue</th>
                    <th class="col-data" data-name="Kiểm định">Kiểm định</th>
                    <th class="col-data" data-name="Quy trình VH">Quy trình VH</th>
                    <th class="col-data" data-name="Quy trình BD">Quy trình BD</th>
                    <th class="col-data" data-name="Định mức">Định mức</th>
                    <th class="col-data" data-name="Đánh giá rủi ro">ĐGRR</th>
                    <th class="col-data" data-name="Biểu mẫu">Biểu mẫu</th>
                    <th class="col-data" data-name="Lịch sử BDSC">Lịch sử BDSC</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="manageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title fs-6 fw-bold">Quản lý Tài liệu / Link</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted mb-3 fst-italic">Bạn có thể sửa tên hiển thị hoặc xoá các link không cần thiết.</p>
                <div id="manageListContainer">
                    </div>
            </div>
            <div class="modal-footer py-1">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="saveManageChanges()">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>
</div>

<input type="file" id="driveUploadInput">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyDltV6zgLaOHZANarD4I87ckl0jBWY8leU",
        authDomain: "dulieubanhang-d6156.firebaseapp.com",
        databaseURL: "https://dulieubanhang-d6156-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "dulieubanhang-d6156",
        storageBucket: "dulieubanhang-d6156.firebasestorage.app",
        messagingSenderId: "588583798336",
        appId: "1:588583798336:web:82a240fb3da2f96893c1a5",
        measurementId: "G-7D51WBK63L"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 2. GOOGLE DRIVE CONFIG
    const CLIENT_ID = "588583798336-o4gjnfqaupmmdp8mi38o9m8r4n0bbghs.apps.googleusercontent.com";
    const FOLDER_ID = "1uyHJHfNFLIdPQbYu1uF4zliORCM6QK3P";
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let tokenClient;
    let accessToken = null;
    let localDataCache = null;
    let localViewMode = false;
    let currentUploadTarget = null; 
    
    // Biến tạm để lưu thông tin khi mở Modal quản lý
    let currentManageTarget = null; 

    const fieldHeaderMap = {
        'ThongSoKT': 'Thông số KT',
        'Catalogue': 'Catalogue',
        'KiemDinh': 'Kiểm định',
        'QuyTrinhVH': 'Quy trình VH',
        'QuyTrinhBD': 'Quy trình BD',
        'DinhMuc': 'Định mức',
        'DGRR': 'Đánh giá rủi ro',
        'BieuMau': 'Biểu mẫu'
    };

    const tableBody = document.getElementById('tableBody');
    const loadingMsg = document.getElementById('loadingMsg');
    const loadingText = document.getElementById('loadingText');
    const facilityNameSpan = document.getElementById('facilityName');
    const editModeToggle = document.getElementById('editModeToggle');
    const driveUploadInput = document.getElementById('driveUploadInput');
    const authBtn = document.getElementById('authBtn');
    const authStatus = document.getElementById('authStatus');
    
    // Modal Element
    const manageModalEl = document.getElementById('manageModal');
    const manageModal = new bootstrap.Modal(manageModalEl);

    window.onload = function() {
        loadAllData();
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (tokenResponse) => {
                accessToken = tokenResponse.access_token;
                if (accessToken) {
                    authBtn.style.display = 'none';
                    authStatus.style.display = 'inline-block';
                }
            },
        });
    };

    window.handleAuthClick = function() {
        if (!accessToken) tokenClient.requestAccessToken({prompt: 'consent'});
    };

    function loadAllData() {
        showLoading("Đang tải dữ liệu...");
        Promise.all([
            get(ref(db, 'settings/tenCoSo')),
            get(ref(db, 'Quanlythietbi'))
        ]).then((results) => {
            const name = results[0].val();
            localDataCache = results[1].val();
            facilityNameSpan.textContent = name ? name : "..........................";
            renderTable(localDataCache);
        }).catch((error) => {
            console.error(error);
            alert("Lỗi tải dữ liệu Firebase.");
        }).finally(() => {
            hideLoading();
        });
    }

    editModeToggle.addEventListener('change', (e) => {
        localViewMode = e.target.checked;
        renderTable(localDataCache);
    });

    // --- RENDER FUNCTION ---
    function renderTable(data) {
        tableBody.innerHTML = "";
        if (!data) {
            tableBody.innerHTML = "<tr><td colspan='12' class='text-center'>Chưa có dữ liệu</td></tr>";
            return;
        }

        const categories = Object.keys(data).sort((a, b) => romanToInt(a) - romanToInt(b));

        categories.forEach(catKey => {
            const catData = data[catKey];
            const rowCat = document.createElement('tr');
            rowCat.className = "category-row";
            rowCat.innerHTML = `<td class="col-stt">${catKey}</td><td colspan="11">${catData.TenPhanLoai || ""}</td>`;
            tableBody.appendChild(rowCat);

            const itemKeys = Object.keys(catData).filter(k => !isNaN(k)).sort((a,b) => a - b);
            
            itemKeys.forEach(itemKey => {
                const item = catData[itemKey];
                const rowItem = document.createElement('tr');

                const createCell = (value, fieldName, isUploadable = false) => {
                    // 1. Logic cho Cột Lịch Sử BDSC (Revert về ô text thường)
                    if (fieldName === 'LichSuBDSC' || fieldName === 'TenThietBi' || fieldName === 'Tagname') {
                        if (localViewMode) {
                            return `<input type="text" class="inline-edit" value="${value || ''}" 
                                    onchange="updateInline('${catKey}', '${itemKey}', '${fieldName}', this.value)">`;
                        } else {
                            // Nếu là Lịch sử BDSC, vẫn giữ tính năng detect link đơn giản nếu có http
                            if (fieldName === 'LichSuBDSC' && value && value.toString().startsWith('http')) {
                                return `<a href="${value}" target="_blank">Xem Link</a>`;
                            }
                            return value || "";
                        }
                    }

                    // 2. Logic cho các cột Tài Liệu (Đa trị)
                    let htmlContent = renderMultiLinkList(value);

                    if (localViewMode && isUploadable) {
                         const toolbar = `
                            <div class="cell-actions">
                                <button class="btn-mini btn-upload" title="Upload" 
                                    onclick="triggerUpload('${catKey}', '${itemKey}', '${fieldName}')">
                                    <i class="fas fa-cloud-upload-alt"></i> Up
                                </button>
                                <button class="btn-mini btn-link" title="Thêm Link" 
                                    onclick="triggerManualLink('${catKey}', '${itemKey}', '${fieldName}')">
                                    <i class="fas fa-plus"></i> Link
                                </button>
                                <button class="btn-mini btn-manage" title="Sửa/Xoá Link" 
                                    onclick="openManageModal('${catKey}', '${itemKey}', '${fieldName}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        `;
                        return toolbar + htmlContent;
                    } 
                    
                    return htmlContent;
                };

                rowItem.innerHTML = `
                    <td class="text-center">${itemKey}</td>
                    <td>${createCell(item.TenThietBi, 'TenThietBi')}</td>
                    <td>${createCell(item.Tagname, 'Tagname', false)}</td> 
                    <td>${createCell(item.ThongSoKT, 'ThongSoKT', true)}</td>
                    <td>${createCell(item.Catalogue, 'Catalogue', true)}</td>
                    <td>${createCell(item.KiemDinh, 'KiemDinh', true)}</td>
                    <td>${createCell(item.QuyTrinhVH, 'QuyTrinhVH', true)}</td>
                    <td>${createCell(item.QuyTrinhBD, 'QuyTrinhBD', true)}</td>
                    <td>${createCell(item.DinhMuc, 'DinhMuc', true)}</td>
                    <td>${createCell(item.DGRR, 'DGRR', true)}</td>
                    <td>${createCell(item.BieuMau, 'BieuMau', true)}</td>
                    <td>${createCell(item.LichSuBDSC, 'LichSuBDSC')}</td>
                `;
                tableBody.appendChild(rowItem);
            });
        });
    }

    // --- MODAL QUẢN LÝ LINK ---
    window.openManageModal = function(catKey, itemKey, fieldName) {
        currentManageTarget = { catKey, itemKey, fieldName };
        const container = document.getElementById('manageListContainer');
        container.innerHTML = "";

        // Lấy dữ liệu hiện tại
        let data = localDataCache[catKey][itemKey][fieldName];
        let items = [];

        // Chuẩn hóa dữ liệu về mảng
        if (data) {
            if (typeof data === 'string') items = [{ name: "Link cũ", url: data }];
            else if (Array.isArray(data)) items = [...data];
            else if (typeof data === 'object') items = Object.values(data);
        }

        if (items.length === 0) {
            container.innerHTML = "<div class='text-center text-muted'>Chưa có link nào.</div>";
        } else {
            items.forEach((item, index) => {
                const displayName = item.name || "File đính kèm";
                const row = document.createElement('div');
                row.className = "manage-item-row";
                row.innerHTML = `
                    <input type="text" class="form-control form-control-sm manage-item-input" 
                        value="${displayName}" placeholder="Tên hiển thị" id="linkName-${index}">
                    
                    <a href="${item.url}" target="_blank" title="Kiểm tra link" class="manage-item-link">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                    
                    <i class="fas fa-trash-alt manage-item-del" title="Xoá link này" 
                        onclick="markDeleted(this)"></i>
                    
                    <input type="hidden" id="linkUrl-${index}" value="${item.url}">
                    <input type="hidden" id="linkCreated-${index}" value="${item.created || Date.now()}">
                `;
                container.appendChild(row);
            });
        }
        manageModal.show();
    };

    // Hàm đánh dấu xoá (chỉ ẩn giao diện, xoá thật khi bấm Lưu)
    window.markDeleted = function(el) {
        const row = el.closest('.manage-item-row');
        if(row) {
            row.classList.add('d-none'); // Ẩn đi
            row.classList.add('marked-delete'); // Đánh dấu xoá
        }
    };

    window.saveManageChanges = async function() {
        if (!currentManageTarget) return;
        const { catKey, itemKey, fieldName } = currentManageTarget;
        
        // Thu thập dữ liệu từ Modal
        const container = document.getElementById('manageListContainer');
        const rows = container.querySelectorAll('.manage-item-row');
        const newData = [];

        rows.forEach((row, index) => {
            // Bỏ qua các dòng đã đánh dấu xoá
            if (row.classList.contains('marked-delete')) return;

            const name = row.querySelector(`#linkName-${index}`).value;
            const url = row.querySelector(`#linkUrl-${index}`).value;
            const created = row.querySelector(`#linkCreated-${index}`).value;

            if (url) {
                newData.push({
                    name: name || "File không tên",
                    url: url,
                    created: parseInt(created)
                });
            }
        });

        // Lưu lên Firebase
        showLoading("Đang lưu thay đổi...");
        try {
            await set(ref(db, `Quanlythietbi/${catKey}/${itemKey}/${fieldName}`), newData);
            
            // Cập nhật Local Cache
            if (!localDataCache[catKey][itemKey]) localDataCache[catKey][itemKey] = {};
            localDataCache[catKey][itemKey][fieldName] = newData;
            
            renderTable(localDataCache);
            manageModal.hide();
        } catch(err) {
            alert("Lỗi khi lưu: " + err.message);
        } finally {
            hideLoading();
        }
    };


    // --- CÁC HÀM HỖ TRỢ KHÁC (GIỮ NGUYÊN) ---
    function renderMultiLinkList(data) {
        if (!data) return "";
        let items = [];
        if (typeof data === 'string') items = [{ name: "Link cũ", url: data }];
        else if (Array.isArray(data)) items = [...data].reverse();
        else if (typeof data === 'object') items = Object.values(data).reverse();

        if (items.length === 0) return "";

        let html = '<div class="multi-link-box">';
        items.forEach(link => {
            const displayName = link.name || "File đính kèm";
            html += `
                <div class="link-item">
                    <i class="fas fa-caret-right text-muted" style="font-size:10px;"></i>
                    <a href="${link.url}" target="_blank" title="${displayName}">${displayName}</a>
                </div>
            `;
        });
        html += '</div>';
        return html;
    }

    // Logic Upload và thêm Link thủ công (như cũ)
    async function appendDataToField(catKey, itemKey, fieldName, newObj) {
        const path = `Quanlythietbi/${catKey}/${itemKey}/${fieldName}`;
        const snapshot = await get(ref(db, path));
        let currentData = snapshot.val();
        let newData = [];

        if (currentData) {
            if (typeof currentData === 'string') newData.push({ name: "Tài liệu cũ", url: currentData, created: Date.now() });
            else if (Array.isArray(currentData)) newData = currentData;
            else if (typeof data === 'object') newData = Object.values(currentData);
        }
        newData.push(newObj);
        await set(ref(db, path), newData);
        
        if (!localDataCache[catKey][itemKey][fieldName]) localDataCache[catKey][itemKey][fieldName] = [];
        if (typeof localDataCache[catKey][itemKey][fieldName] === 'string') {
             localDataCache[catKey][itemKey][fieldName] = [{name:"Tài liệu cũ", url:localDataCache[catKey][itemKey][fieldName]}];
        }
        localDataCache[catKey][itemKey][fieldName].push(newObj);
        renderTable(localDataCache);
    }

    window.triggerUpload = function(catKey, itemKey, fieldName) {
        if (!accessToken) { alert("Vui lòng nhấn nút 'Đăng nhập Drive' trước!"); return; }
        currentUploadTarget = { catKey, itemKey, fieldName };
        driveUploadInput.click();
    };

    driveUploadInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentUploadTarget) return;
        const { catKey, itemKey, fieldName } = currentUploadTarget;
        const suggestName = fieldHeaderMap[fieldName] || fieldName;
        const userFileName = prompt(`Nhập tên hiển thị:\n(Ví dụ: ${suggestName} T10)`, suggestName);
        if (userFileName === null) { driveUploadInput.value = ""; return; }

        showLoading(`Đang tải lên: ${file.name}...`);
        try {
            const metadata = { 'name': file.name, 'mimeType': file.type || 'application/octet-stream', 'parents': [FOLDER_ID] };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
                method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }), body: form
            });
            if (!response.ok) throw new Error((await response.json()).error.message);
            const data = await response.json();
            await appendDataToField(catKey, itemKey, fieldName, { name: userFileName || file.name, url: data.webViewLink, created: Date.now() });
        } catch (error) { alert("Lỗi upload: " + error.message); } 
        finally { hideLoading(); driveUploadInput.value = ""; currentUploadTarget = null; }
    });

    window.triggerManualLink = async function(catKey, itemKey, fieldName) {
        const url = prompt("Dán đường link của bạn vào đây:");
        if (!url) return;
        const suggestName = fieldHeaderMap[fieldName] || fieldName;
        const name = prompt(`Nhập tên hiển thị:\n(Ví dụ: ${suggestName})`, suggestName);
        if (name === null) return;
        showLoading("Đang lưu link...");
        try {
            await appendDataToField(catKey, itemKey, fieldName, { name: name || "Link", url: url, created: Date.now() });
        } catch(err) { alert("Lỗi lưu: " + err.message); } finally { hideLoading(); }
    }

    window.updateInline = function(catKey, itemKey, fieldName, newValue) {
        update(ref(db, `Quanlythietbi/${catKey}/${itemKey}`), { [fieldName]: newValue })
            .then(() => { if(localDataCache[catKey][itemKey]) localDataCache[catKey][itemKey][fieldName] = newValue; })
            .catch((err) => alert("Lỗi cập nhật: " + err.message));
    };

    const fileInputExcel = document.getElementById('fileInputExcel');
    fileInputExcel.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        showLoading("Đang nhập Excel...");
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1, defval: ""});
                const dataToPush = processExcelData(jsonData);
                set(ref(db, 'Quanlythietbi'), dataToPush)
                    .then(() => { alert("Xong!"); loadAllData(); })
                    .finally(() => { hideLoading(); fileInputExcel.value = ""; });
            } catch (err) { alert(err.message); hideLoading(); }
        };
        reader.readAsArrayBuffer(file);
    });

    function showLoading(msg) { loadingText.innerText = msg; loadingMsg.style.display = "flex"; }
    function hideLoading() { loadingMsg.style.display = "none"; }
    function romanToInt(s) { if(!s) return 0; const roman = {'I':1,'V':5,'X':10,'L':50,'C':100}; let num = 0; for(let i=0; i < s.length; i++){ if(i+1 < s.length && roman[s[i]] < roman[s[i+1]]) num -= roman[s[i]]; else num += roman[s[i]]; } return num; }
    function isRoman(str) { if (!str) return false; return /^M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/i.test(str.toString().trim()) && isNaN(str); }
    
    function processExcelData(rows) {
        let headerIndex = -1;
        for(let i=0; i<rows.length; i++){
            const rowStr = rows[i].join(" ").toUpperCase();
            if(rowStr.includes("STT") && rowStr.includes("TAGNAME")) { headerIndex = i; break; }
        }
        if(headerIndex === -1) throw new Error("Không tìm thấy header");
        const result = {}; let currentCat = null;
        for(let i = headerIndex + 1; i < rows.length; i++){
            const row = rows[i]; const stt = row[0] ? row[0].toString().trim() : "";
            if(!stt) continue;
            if(isRoman(stt)) {
                currentCat = stt; result[currentCat] = { "TenPhanLoai": row[1] || "" };
            } else if (!isNaN(stt) && currentCat) {
                result[currentCat][stt] = {
                    "TenThietBi": row[1] || "", "Tagname": row[2] || "",
                    "ThongSoKT": row[3] || "", "Catalogue": row[4] || "",
                    "KiemDinh": row[5] || "", "QuyTrinhVH": row[6] || "",
                    "QuyTrinhBD": row[7] || "", "DinhMuc": row[8] || "",
                    "DGRR": row[9] || "", "BieuMau": row[10] || "",
                    "LichSuBDSC": row[11] || ""
                };
            }
        }
        return result;
    }
</script>

</body>
</html>
